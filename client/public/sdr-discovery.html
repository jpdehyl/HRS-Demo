<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDR Discovery Interview | Lead Intel</title>
    <style>
        :root {
            --primary: #2C88C9;
            --secondary: #F26419;
            --dark: #1a2744;
            --light: #f8f9fa;
            --success: #059669;
            --warning: #F59E0B;
            --danger: #DC2626;
            --text: #333;
            --border: #e5e7eb;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text);
            background: var(--light);
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
            padding: 20px;
            min-height: 100vh;
        }
        @media (max-width: 1024px) {
            .container { grid-template-columns: 1fr; }
            .sidebar { display: none; }
        }

        /* Header */
        header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, var(--dark), var(--primary));
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 { font-size: 1.5rem; }
        .header-meta { text-align: right; font-size: 0.9rem; opacity: 0.9; }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-badge.recording { background: var(--danger); animation: pulse 2s infinite; }
        .status-badge.saved { background: var(--success); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* Main Content */
        .main-content { display: flex; flex-direction: column; gap: 20px; }

        /* Meeting Info */
        .meeting-info {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .meeting-info h2 { font-size: 1.1rem; margin-bottom: 1rem; color: var(--dark); }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .info-field label {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
        }
        .info-field input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.95rem;
        }
        .info-field input:focus { outline: none; border-color: var(--primary); }

        /* Question Card */
        .question-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .question-header {
            background: var(--dark);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-badge {
            background: var(--primary);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        .question-number { font-size: 0.9rem; opacity: 0.8; }
        .question-body { padding: 1.5rem; }
        .question-text {
            font-size: 1.15rem;
            font-weight: 500;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }
        .question-context {
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
            margin-bottom: 1rem;
        }
        .answer-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
        }
        .answer-textarea:focus { outline: none; border-color: var(--primary); }
        .answer-textarea.has-content { border-color: var(--success); }

        /* AI Follow-ups */
        .ai-suggestions {
            margin-top: 1rem;
            padding: 1rem;
            background: #FEF3C7;
            border-radius: 8px;
            border-left: 4px solid var(--warning);
        }
        .ai-suggestions.loading {
            background: #EEF2FF;
            border-left-color: var(--primary);
        }
        .ai-suggestions h4 {
            font-size: 0.85rem;
            color: var(--dark);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .ai-suggestions h4::before { content: ""; }
        .follow-up-item {
            padding: 8px 12px;
            margin: 6px 0;
            background: white;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .follow-up-item:hover { border-color: var(--primary); transform: translateX(4px); }
        .follow-up-item .priority {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }
        .priority.high { background: #FEE2E2; color: var(--danger); }
        .priority.medium { background: #FEF3C7; color: #92400E; }
        .priority.low { background: #E0E7FF; color: #3730A3; }

        .interviewer-tip {
            margin-top: 0.75rem;
            padding: 8px 12px;
            background: #ECFDF5;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #065F46;
        }

        /* Navigation */
        .question-nav {
            display: flex;
            gap: 12px;
            padding: 1rem 1.5rem;
            background: #f9fafb;
            border-top: 1px solid var(--border);
        }
        .nav-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-btn.secondary { background: white; border: 1px solid var(--border); color: var(--text); }
        .nav-btn.secondary:hover { background: var(--light); }
        .nav-btn.primary { background: var(--primary); color: white; }
        .nav-btn.primary:hover { background: #2474AB; }
        .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Sidebar */
        .sidebar { display: flex; flex-direction: column; gap: 16px; }
        .sidebar-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        .sidebar-header {
            padding: 12px 16px;
            background: var(--dark);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .sidebar-body { padding: 12px 16px; }

        /* Progress */
        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            transition: width 0.3s;
        }
        .progress-text { font-size: 0.85rem; color: #666; }

        /* Insights */
        .insight-item {
            padding: 8px 10px;
            margin: 6px 0;
            border-radius: 6px;
            font-size: 0.85rem;
            border-left: 3px solid;
        }
        .insight-item.pain_point { background: #FEE2E2; border-color: var(--danger); }
        .insight-item.integration_need { background: #DBEAFE; border-color: var(--primary); }
        .insight-item.feature_request { background: #D1FAE5; border-color: var(--success); }
        .insight-item.adoption_blocker { background: #FEF3C7; border-color: var(--warning); }
        .insight-item.positive_signal { background: #ECFDF5; border-color: #10B981; }
        .insight-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            display: block;
            margin-bottom: 2px;
        }

        /* Section Outline */
        .section-item {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .section-item:hover { background: var(--light); }
        .section-item.active { background: #DBEAFE; color: var(--primary); font-weight: 500; }
        .section-item.completed { color: var(--success); }
        .section-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
        }
        .section-item.active .section-dot { background: var(--primary); }
        .section-item.completed .section-dot { background: var(--success); }

        /* Actions */
        .action-buttons { display: flex; flex-direction: column; gap: 8px; }
        .action-btn {
            width: 100%;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .action-btn.save { background: var(--success); color: white; }
        .action-btn.save:hover { background: #047857; }
        .action-btn.export { background: white; border: 1px solid var(--border); }
        .action-btn.export:hover { background: var(--light); }
        .action-btn.finish { background: var(--secondary); color: white; }
        .action-btn.finish:hover { background: #D9580F; }

        /* Conversation History */
        .history-item {
            padding: 10px;
            margin: 6px 0;
            background: var(--light);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        .history-item .q { font-weight: 500; color: var(--dark); margin-bottom: 4px; }
        .history-item .a { color: #666; }
        .history-scroll { max-height: 250px; overflow-y: auto; }

        /* Print Styles */
        @media print {
            .sidebar, .question-nav, .ai-suggestions, .nav-btn { display: none; }
            .container { display: block; }
            .question-card { break-inside: avoid; margin-bottom: 1rem; }
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Summary Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
            margin: 1rem;
        }
        .modal-content h2 { margin-bottom: 1rem; color: var(--dark); }
        .summary-section { margin: 1.5rem 0; }
        .summary-section h3 { font-size: 1rem; color: var(--primary); margin-bottom: 0.5rem; }
        .fit-score {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary);
            text-align: center;
            margin: 1rem 0;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>SDR Discovery Interview</h1>
                <p>Hawk Ridge Systems - Lead Intel Fit Assessment</p>
            </div>
            <div class="header-meta">
                <div id="statusBadge" class="status-badge recording">Recording</div>
                <div id="meetingTime" style="margin-top: 4px;"></div>
            </div>
        </header>

        <main class="main-content">
            <!-- Meeting Info -->
            <section class="meeting-info">
                <h2>Meeting Information</h2>
                <div class="info-grid">
                    <div class="info-field">
                        <label>Interviewee Name</label>
                        <input type="text" id="intervieweeName" placeholder="SDR's name">
                    </div>
                    <div class="info-field">
                        <label>Role</label>
                        <input type="text" id="intervieweeRole" value="Sales Development Representative">
                    </div>
                    <div class="info-field">
                        <label>Company</label>
                        <input type="text" id="intervieweeCompany" value="Hawk Ridge Systems">
                    </div>
                    <div class="info-field">
                        <label>Interviewer</label>
                        <input type="text" id="interviewer" placeholder="Your name">
                    </div>
                </div>
            </section>

            <!-- Current Question -->
            <section class="question-card">
                <div class="question-header">
                    <span id="sectionBadge" class="section-badge">Opening</span>
                    <span id="questionNumber" class="question-number">Question 1 of 35</span>
                </div>
                <div class="question-body">
                    <h3 id="questionText" class="question-text"></h3>
                    <p id="questionContext" class="question-context"></p>
                    <textarea
                        id="answerInput"
                        class="answer-textarea"
                        placeholder="Type the SDR's response here..."
                    ></textarea>

                    <div id="aiSuggestions" class="ai-suggestions hidden">
                        <h4>AI-Suggested Follow-ups</h4>
                        <div id="followUpList"></div>
                        <div id="interviewerTip" class="interviewer-tip"></div>
                    </div>
                </div>
                <div class="question-nav">
                    <button id="prevBtn" class="nav-btn secondary" disabled>Previous</button>
                    <button id="skipBtn" class="nav-btn secondary">Skip Question</button>
                    <button id="nextBtn" class="nav-btn primary">Next Question</button>
                </div>
            </section>
        </main>

        <aside class="sidebar">
            <!-- Progress -->
            <div class="sidebar-card">
                <div class="sidebar-header">Progress</div>
                <div class="sidebar-body">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div id="progressText" class="progress-text">0 of 35 questions answered</div>
                </div>
            </div>

            <!-- Sections -->
            <div class="sidebar-card">
                <div class="sidebar-header">Interview Sections</div>
                <div class="sidebar-body" id="sectionList"></div>
            </div>

            <!-- Live Insights -->
            <div class="sidebar-card">
                <div class="sidebar-header">Live Insights</div>
                <div class="sidebar-body">
                    <div id="insightsList" style="max-height: 200px; overflow-y: auto;">
                        <p style="color: #999; font-size: 0.85rem;">Insights will appear as you record answers...</p>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="sidebar-card">
                <div class="sidebar-header">Actions</div>
                <div class="sidebar-body action-buttons">
                    <button id="saveBtn" class="action-btn save">Save Progress</button>
                    <button id="finishBtn" class="action-btn finish">Finish & Generate Summary</button>
                    <button id="exportBtn" class="action-btn export">Export to JSON</button>
                </div>
            </div>

            <!-- Recent History -->
            <div class="sidebar-card">
                <div class="sidebar-header">Recent Responses</div>
                <div class="sidebar-body history-scroll" id="historyList">
                    <p style="color: #999; font-size: 0.85rem;">Responses will appear here...</p>
                </div>
            </div>
        </aside>
    </div>

    <!-- Summary Modal -->
    <div id="summaryModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2>Interview Summary</h2>
            <div id="summaryContent"></div>
            <div style="margin-top: 1.5rem; display: flex; gap: 12px;">
                <button onclick="saveFinalSummary()" class="nav-btn primary">Save to Database</button>
                <button onclick="closeSummaryModal()" class="nav-btn secondary">Close</button>
            </div>
        </div>
    </div>

    <script>
        // ============ QUESTIONNAIRE DATA ============
        const SECTIONS = [
            { id: 'opening', name: 'Opening & Rapport', icon: '' },
            { id: 'workflow', name: 'Current Workflow', icon: '' },
            { id: 'salesforce', name: 'Salesforce Usage', icon: '' },
            { id: 'zoom', name: 'Zoom Phone & ZRA', icon: '' },
            { id: 'research', name: 'Pre-Call Research', icon: '' },
            { id: 'coaching', name: 'Coaching & Performance', icon: '' },
            { id: 'tools', name: 'Tool Adoption', icon: '' },
            { id: 'demo', name: 'Demo Feedback', icon: '' },
            { id: 'integration', name: 'Integration Needs', icon: '' },
            { id: 'closing', name: 'Closing', icon: '' },
        ];

        const QUESTIONS = [
            // Opening (2 questions)
            { section: 'opening', question: "Before we dive in, how long have you been in your SDR role at Hawk Ridge?", context: "Warm-up question to build rapport." },
            { section: 'opening', question: "What products/solutions do you primarily sell? (SOLIDWORKS, CAM, etc.)", context: "Understanding their product focus helps contextualize pain points." },

            // Workflow (4 questions)
            { section: 'workflow', question: "Walk me through a typical day as an SDR at Hawk Ridge. What does your workflow look like from start to finish?", context: "Understanding the full picture helps identify where Lead Intel adds value." },
            { section: 'workflow', question: "How many calls do you typically make per day? How many convert to meaningful conversations?", context: "Baseline metrics for measuring potential impact." },
            { section: 'workflow', question: "What percentage of your time is spent on pre-call research vs. actually making calls?", context: "If research takes too long, Lead Intel's AI research can save time." },
            { section: 'workflow', question: "How do you prioritize which leads to call first?", context: "Understanding prioritization helps position Lead Intel's fit scoring." },

            // Salesforce (5 questions)
            { section: 'salesforce', question: "How do you currently use Salesforce in your daily workflow? What data do you rely on most?", context: "Critical for understanding integration needs.", priority: 'high' },
            { section: 'salesforce', question: "What lead/contact fields in Salesforce are most important for your pre-call preparation?", context: "Lead Intel can pull and display this data automatically." },
            { section: 'salesforce', question: "What frustrates you most about Salesforce? What's missing or broken?", context: "Pain points reveal opportunities for Lead Intel.", priority: 'high' },
            { section: 'salesforce', question: "How do you log call outcomes and notes? Is this process efficient or tedious?", context: "Post-call summary automation opportunity." },
            { section: 'salesforce', question: "Do you use any Salesforce integrations or apps? (Outreach, SalesLoft, Gong, etc.)", context: "Understanding the ecosystem prevents conflicts." },

            // Zoom Phone & ZRA (5 questions)
            { section: 'zoom', question: "How do you use Zoom Phone for calls? Do you dial from Salesforce, Zoom directly, or another way?", context: "Critical for click-to-dial integration.", priority: 'high' },
            { section: 'zoom', question: "Tell me about your experience with ZRA (Zoom Revenue Accelerator). What features do you use most?", context: "Understanding overlap with Lead Intel is crucial.", priority: 'high' },
            { section: 'zoom', question: "Does ZRA provide call transcriptions and AI summaries? How useful are they?", context: "If ZRA handles this, Lead Intel should focus elsewhere.", priority: 'high' },
            { section: 'zoom', question: "What call analytics or coaching insights does ZRA provide? Do managers use this data?", context: "Prevents feature duplication." },
            { section: 'zoom', question: "What's missing from Zoom Phone/ZRA that would make your job easier?", context: "Direct opportunity identification." },

            // Pre-Call Research (4 questions)
            { section: 'research', question: "What research do you do before making a call? Where do you get this information?", context: "Lead Intel's core value prop - understand current habits.", priority: 'high' },
            { section: 'research', question: "What information, if you had it instantly before a call, would make you significantly more effective?", context: "Dream scenario helps prioritize AI research features." },
            { section: 'research', question: "How much time do you spend researching a prospect before calling? Is it worth it?", context: "ROI question - if research doesn't pay off, they may skip it." },
            { section: 'research', question: "Do you use any tools for company research? (LinkedIn Sales Navigator, ZoomInfo, Apollo, etc.)", context: "Competitive landscape." },

            // Coaching & Performance (4 questions)
            { section: 'coaching', question: "How does your manager currently coach you? Do they review call recordings?", context: "Understanding coaching workflows." },
            { section: 'coaching', question: "Would real-time coaching tips during a call be helpful or distracting?", context: "Critical UX question - some may find live coaching intrusive." },
            { section: 'coaching', question: "What metrics are you measured on? (Calls made, conversations, meetings booked, etc.)", context: "Lead Intel can help track key metrics." },
            { section: 'coaching', question: "What would help you book more meetings? What's your biggest blocker?", context: "Direct value question.", priority: 'high' },

            // Tool Adoption (4 questions)
            { section: 'tools', question: "What makes you actually use a new tool vs. abandoning it after a week?", context: "Critical for ensuring Lead Intel gets adopted.", priority: 'high' },
            { section: 'tools', question: "How many browser tabs/apps do you have open during a typical calling session?", context: "If overwhelmed, another app might not help." },
            { section: 'tools', question: "If Lead Intel could do ONE thing exceptionally well, what should it be?", context: "Forces prioritization.", priority: 'high' },
            { section: 'tools', question: "Would you prefer Lead Intel as a standalone app, Salesforce widget, browser extension, or something else?", context: "Delivery mechanism affects adoption." },

            // Demo Feedback (4 questions - show after demo)
            { section: 'demo', question: "[After demo] What features stood out as genuinely useful for your workflow?", context: "Positive validation.", priority: 'high' },
            { section: 'demo', question: "[After demo] What's missing that you'd need to actually use this tool daily?", context: "Gap analysis for product roadmap.", priority: 'high' },
            { section: 'demo', question: "[After demo] Does anything in Lead Intel duplicate what you already have?", context: "Avoiding duplication is essential." },
            { section: 'demo', question: "[After demo] On a scale of 1-10, how likely would you be to use Lead Intel daily? Why?", context: "NPS-style with qualitative follow-up." },

            // Integration Requirements (3 questions)
            { section: 'integration', question: "If Lead Intel integrated with Salesforce, what data should it pull automatically?", context: "Specific Salesforce integration needs.", priority: 'high' },
            { section: 'integration', question: "If Lead Intel integrated with Zoom Phone, what would be most valuable? (Click-to-dial, call logging, etc.)", context: "Specific Zoom integration needs.", priority: 'high' },
            { section: 'integration', question: "Would you want Lead Intel to sync data back to Salesforce? (Call notes, AI insights)", context: "Bi-directional sync requirements." },

            // Closing (2 questions)
            { section: 'closing', question: "Is there anything else about your workflow or challenges that we haven't covered?", context: "Open-ended to catch anything missed." },
            { section: 'closing', question: "Who else at Hawk Ridge should we talk to? (Other SDRs, managers, AEs)", context: "Expand discovery scope." },
        ];

        // ============ STATE ============
        let currentIndex = 0;
        let answers = {};
        let conversationHistory = [];
        let allInsights = [];
        let aiSuggestionsEnabled = true;
        let pendingFollowUps = [];
        let generatedSummary = null;

        // ============ INITIALIZATION ============
        function init() {
            updateMeetingTime();
            setInterval(updateMeetingTime, 1000);
            renderSectionList();
            renderQuestion();
            setupEventListeners();
            loadSavedProgress();
        }

        function updateMeetingTime() {
            const now = new Date();
            document.getElementById('meetingTime').textContent = now.toLocaleTimeString();
        }

        function renderSectionList() {
            const container = document.getElementById('sectionList');
            container.innerHTML = SECTIONS.map(section => {
                const questionsInSection = QUESTIONS.filter(q => q.section === section.id);
                const answeredCount = questionsInSection.filter(q => {
                    const idx = QUESTIONS.indexOf(q);
                    return answers[idx] && answers[idx].trim();
                }).length;
                const isComplete = answeredCount === questionsInSection.length;
                const isCurrent = QUESTIONS[currentIndex].section === section.id;

                return `
                    <div class="section-item ${isCurrent ? 'active' : ''} ${isComplete ? 'completed' : ''}"
                         onclick="goToSection('${section.id}')">
                        <span class="section-dot"></span>
                        <span>${section.icon} ${section.name}</span>
                        <span style="margin-left:auto; font-size:0.75rem; color:#999;">${answeredCount}/${questionsInSection.length}</span>
                    </div>
                `;
            }).join('');
        }

        function goToSection(sectionId) {
            const idx = QUESTIONS.findIndex(q => q.section === sectionId);
            if (idx !== -1) {
                currentIndex = idx;
                renderQuestion();
            }
        }

        function renderQuestion() {
            const q = QUESTIONS[currentIndex];
            const section = SECTIONS.find(s => s.id === q.section);

            document.getElementById('sectionBadge').textContent = section.name;
            document.getElementById('questionNumber').textContent = `Question ${currentIndex + 1} of ${QUESTIONS.length}`;
            document.getElementById('questionText').textContent = q.question;
            document.getElementById('questionContext').textContent = q.context;

            const textarea = document.getElementById('answerInput');
            textarea.value = answers[currentIndex] || '';
            textarea.classList.toggle('has-content', !!answers[currentIndex]);

            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('nextBtn').textContent = currentIndex === QUESTIONS.length - 1 ? 'Finish' : 'Next Question';

            // Hide AI suggestions initially
            document.getElementById('aiSuggestions').classList.add('hidden');

            updateProgress();
            renderSectionList();
            renderHistory();
        }

        function updateProgress() {
            const answered = Object.values(answers).filter(a => a && a.trim()).length;
            const percent = (answered / QUESTIONS.length) * 100;
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${answered} of ${QUESTIONS.length} questions answered`;
        }

        function renderHistory() {
            const container = document.getElementById('historyList');
            const recentHistory = conversationHistory.slice(-5).reverse();

            if (recentHistory.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 0.85rem;">Responses will appear here...</p>';
                return;
            }

            container.innerHTML = recentHistory.map(entry => `
                <div class="history-item">
                    <div class="q">${entry.question.substring(0, 60)}...</div>
                    <div class="a">${entry.answer.substring(0, 100)}${entry.answer.length > 100 ? '...' : ''}</div>
                </div>
            `).join('');
        }

        function renderInsights() {
            const container = document.getElementById('insightsList');

            if (allInsights.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 0.85rem;">Insights will appear as you record answers...</p>';
                return;
            }

            container.innerHTML = allInsights.slice(-10).reverse().map(insight => `
                <div class="insight-item ${insight.type}">
                    <span class="insight-label">${insight.type.replace('_', ' ')}</span>
                    ${insight.content}
                </div>
            `).join('');
        }

        // ============ EVENT HANDLERS ============
        function setupEventListeners() {
            const textarea = document.getElementById('answerInput');
            let debounceTimer;

            textarea.addEventListener('input', (e) => {
                answers[currentIndex] = e.target.value;
                e.target.classList.toggle('has-content', !!e.target.value.trim());

                // Debounce AI suggestions
                clearTimeout(debounceTimer);
                if (e.target.value.trim().length > 50 && aiSuggestionsEnabled) {
                    debounceTimer = setTimeout(() => generateAiSuggestions(), 1500);
                }
            });

            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentIndex > 0) {
                    saveCurrentAnswer();
                    currentIndex--;
                    renderQuestion();
                }
            });

            document.getElementById('nextBtn').addEventListener('click', () => {
                saveCurrentAnswer();
                if (currentIndex < QUESTIONS.length - 1) {
                    currentIndex++;
                    renderQuestion();
                } else {
                    finishInterview();
                }
            });

            document.getElementById('skipBtn').addEventListener('click', () => {
                if (currentIndex < QUESTIONS.length - 1) {
                    currentIndex++;
                    renderQuestion();
                }
            });

            document.getElementById('saveBtn').addEventListener('click', saveProgress);
            document.getElementById('finishBtn').addEventListener('click', finishInterview);
            document.getElementById('exportBtn').addEventListener('click', exportToJson);
        }

        function saveCurrentAnswer() {
            const answer = document.getElementById('answerInput').value.trim();
            if (answer) {
                answers[currentIndex] = answer;

                // Add to conversation history
                const q = QUESTIONS[currentIndex];
                const existingIdx = conversationHistory.findIndex(h => h.question === q.question);
                const entry = {
                    question: q.question,
                    answer: answer,
                    section: q.section,
                    timestamp: new Date().toISOString()
                };

                if (existingIdx !== -1) {
                    conversationHistory[existingIdx] = entry;
                } else {
                    conversationHistory.push(entry);
                }
            }
        }

        // ============ AI INTEGRATION ============
        async function generateAiSuggestions() {
            const answer = document.getElementById('answerInput').value.trim();
            if (answer.length < 30) return;

            const q = QUESTIONS[currentIndex];
            const remainingQuestions = QUESTIONS.slice(currentIndex + 1).map(q => q.question);

            const suggestionsDiv = document.getElementById('aiSuggestions');
            suggestionsDiv.classList.remove('hidden');
            suggestionsDiv.classList.add('loading');
            suggestionsDiv.innerHTML = `<h4><span class="spinner"></span> Analyzing response...</h4>`;

            try {
                const response = await fetch('/api/discovery/follow-up', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        currentQuestion: q.question,
                        currentAnswer: answer,
                        currentSection: q.section,
                        conversationHistory: conversationHistory,
                        remainingQuestions: remainingQuestions.slice(0, 10)
                    })
                });

                if (!response.ok) throw new Error('API error');

                const result = await response.json();

                // Store insights
                if (result.insights && result.insights.length > 0) {
                    allInsights.push(...result.insights);
                    renderInsights();
                }

                // Store follow-ups
                pendingFollowUps = result.followUpQuestions || [];

                // Render suggestions
                suggestionsDiv.classList.remove('loading');
                renderAiSuggestions(result);

            } catch (error) {
                console.error('AI suggestion error:', error);
                suggestionsDiv.classList.add('hidden');
            }
        }

        function renderAiSuggestions(result) {
            const container = document.getElementById('aiSuggestions');
            const followUpList = document.getElementById('followUpList');
            const tipDiv = document.getElementById('interviewerTip');

            if (!result.followUpQuestions || result.followUpQuestions.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.innerHTML = `
                <h4>AI-Suggested Follow-ups</h4>
                <div id="followUpList">
                    ${result.followUpQuestions.map((fu, i) => `
                        <div class="follow-up-item" onclick="useFollowUp(${i})">
                            ${fu.question}
                            <span class="priority ${fu.priority}">${fu.priority}</span>
                        </div>
                    `).join('')}
                </div>
                ${result.conversationTips ? `
                    <div class="interviewer-tip">
                        <strong>Tip:</strong> ${result.conversationTips}
                    </div>
                ` : ''}
            `;
        }

        function useFollowUp(index) {
            const followUp = pendingFollowUps[index];
            if (!followUp) return;

            // Insert as next question
            const newQuestion = {
                section: QUESTIONS[currentIndex].section,
                question: followUp.question,
                context: `AI-generated follow-up: ${followUp.rationale}`,
                isFollowUp: true
            };

            QUESTIONS.splice(currentIndex + 1, 0, newQuestion);

            // Move to it
            saveCurrentAnswer();
            currentIndex++;
            renderQuestion();
        }

        // ============ SAVE & EXPORT ============
        async function saveProgress() {
            saveCurrentAnswer();

            const btn = document.getElementById('saveBtn');
            btn.textContent = 'Saving...';
            btn.disabled = true;

            try {
                localStorage.setItem('sdr-discovery-progress', JSON.stringify({
                    answers,
                    conversationHistory,
                    allInsights,
                    currentIndex,
                    meetingInfo: getMeetingInfo()
                }));

                btn.textContent = 'Saved!';
                setTimeout(() => {
                    btn.textContent = 'Save Progress';
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Save error:', error);
                btn.textContent = 'Save Failed';
                btn.disabled = false;
            }
        }

        function loadSavedProgress() {
            try {
                const saved = localStorage.getItem('sdr-discovery-progress');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (confirm('Found saved progress. Would you like to restore it?')) {
                        answers = data.answers || {};
                        conversationHistory = data.conversationHistory || [];
                        allInsights = data.allInsights || [];
                        currentIndex = data.currentIndex || 0;

                        if (data.meetingInfo) {
                            document.getElementById('intervieweeName').value = data.meetingInfo.intervieweeName || '';
                            document.getElementById('intervieweeRole').value = data.meetingInfo.intervieweeRole || '';
                            document.getElementById('intervieweeCompany').value = data.meetingInfo.intervieweeCompany || '';
                            document.getElementById('interviewer').value = data.meetingInfo.interviewer || '';
                        }

                        renderQuestion();
                        renderInsights();
                    }
                }
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        function getMeetingInfo() {
            return {
                intervieweeName: document.getElementById('intervieweeName').value,
                intervieweeRole: document.getElementById('intervieweeRole').value,
                intervieweeCompany: document.getElementById('intervieweeCompany').value,
                interviewer: document.getElementById('interviewer').value
            };
        }

        function exportToJson() {
            saveCurrentAnswer();

            const data = {
                meetingInfo: getMeetingInfo(),
                meetingDate: new Date().toISOString(),
                responses: conversationHistory,
                insights: allInsights,
                questions: QUESTIONS.map((q, i) => ({
                    ...q,
                    answer: answers[i] || null
                }))
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sdr-discovery-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        async function finishInterview() {
            saveCurrentAnswer();

            const modal = document.getElementById('summaryModal');
            const content = document.getElementById('summaryContent');
            modal.classList.remove('hidden');
            content.innerHTML = '<p style="text-align:center;"><span class="spinner" style="border-color:#333;border-top-color:transparent;width:24px;height:24px;"></span><br>Generating AI summary...</p>';

            try {
                const response = await fetch('/api/discovery/summary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        conversationHistory,
                        allInsights
                    })
                });

                if (!response.ok) throw new Error('Summary generation failed');

                generatedSummary = await response.json();
                renderSummary(generatedSummary);

            } catch (error) {
                console.error('Summary error:', error);
                content.innerHTML = `
                    <p style="color: var(--danger);">Failed to generate summary. You can still save your responses.</p>
                    <button onclick="saveFinalSummary()" class="nav-btn primary" style="margin-top:1rem;">Save Responses Only</button>
                `;
            }
        }

        function renderSummary(summary) {
            const content = document.getElementById('summaryContent');
            content.innerHTML = `
                <div class="fit-score">${summary.productFitScore}/10</div>
                <p style="text-align:center; color:#666; margin-bottom:1.5rem;">${summary.productFitRationale}</p>

                <div class="summary-section">
                    <h3>Executive Summary</h3>
                    <p>${summary.executiveSummary}</p>
                </div>

                <div class="summary-section">
                    <h3>Key Pain Points</h3>
                    <ul>${summary.keyPainPoints.map(p => `<li>${p}</li>`).join('')}</ul>
                </div>

                <div class="summary-section">
                    <h3>Integration Requirements</h3>
                    <ul>${summary.integrationRequirements.map(r => `<li>${r}</li>`).join('')}</ul>
                </div>

                <div class="summary-section">
                    <h3>Feature Requests</h3>
                    <ul>${summary.featureRequests.map(f => `<li>${f}</li>`).join('')}</ul>
                </div>

                <div class="summary-section">
                    <h3>Adoption Blockers</h3>
                    <ul>${summary.adoptionBlockers.map(b => `<li>${b}</li>`).join('')}</ul>
                </div>

                <div class="summary-section">
                    <h3>Recommended Next Steps</h3>
                    <ul>${summary.recommendedNextSteps.map(s => `<li>${s}</li>`).join('')}</ul>
                </div>
            `;
        }

        async function saveFinalSummary() {
            const meetingInfo = getMeetingInfo();

            if (!meetingInfo.intervieweeName) {
                alert('Please enter the interviewee name before saving.');
                return;
            }

            try {
                const response = await fetch('/api/discovery', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        meetingDate: new Date().toISOString(),
                        intervieweeName: meetingInfo.intervieweeName,
                        intervieweeRole: meetingInfo.intervieweeRole,
                        intervieweeCompany: meetingInfo.intervieweeCompany,
                        interviewer: meetingInfo.interviewer,
                        responses: conversationHistory,
                        keyPainPoints: generatedSummary?.keyPainPoints || [],
                        integrationRequirements: generatedSummary?.integrationRequirements || [],
                        featureRequests: generatedSummary?.featureRequests || [],
                        adoptionBlockers: generatedSummary?.adoptionBlockers || [],
                        likelihoodToUse: generatedSummary?.productFitScore || null,
                        executiveSummary: generatedSummary?.executiveSummary || null,
                        actionItems: generatedSummary?.recommendedNextSteps || [],
                        status: 'completed'
                    })
                });

                if (!response.ok) throw new Error('Save failed');

                const result = await response.json();

                // Clear local storage
                localStorage.removeItem('sdr-discovery-progress');

                // Update status
                document.getElementById('statusBadge').textContent = 'Saved';
                document.getElementById('statusBadge').classList.remove('recording');
                document.getElementById('statusBadge').classList.add('saved');

                alert('Interview saved successfully! ID: ' + result.id);
                closeSummaryModal();

            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save. Please try exporting to JSON instead.');
            }
        }

        function closeSummaryModal() {
            document.getElementById('summaryModal').classList.add('hidden');
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
